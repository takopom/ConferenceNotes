
# スライド

http://y-anz-m.blogspot.jp/2017/03/droidkaigi-2017_9.html

# 背景

作って終わりのアプリは、設計はあまり考えない。  
Androidユーザは世界で8割。  
Android対応するのが当たり前の世の中になった。

作って終わりではない、継続的なメンテナンス、機能追加が必要になってきた。  
プラットフォームの進化にも対応する。

個人での開発から、複数人での開発になってきた。  
「他の人が書いたところを全部読まないとわからない」という状況では困る。

どうすれば複数人で安定して素早く開発できるか？

技術的なパターンを適用するだけでうまくいけば、誰しもがうまくいってるはず。  
でもうまくいってない現実…

そこでドメイン駆動設計。

# ドメイン駆動設計の本

- [エリック・エヴァンスのドメイン駆動設計](http://amzn.asia/1OvjNIX)
 - チームで一人は読み切った人がいる方が良い

- [実践ドメイン駆動設計](http://amzn.asia/cuZ9Kxt)
 - こちらの方がチームで学びながらできるが、上の本を読んだ前提で書かれているところがある。


# ドメイン駆動設計とは何か

## ドメイン？

ユーザがプログラムを適用する対象領域

- レシピ検索アプリ 「料理のレシピ」
- アパート検索アプリ「住まい、住むこと」そのもの
- Uber 「近距離移動」
- Github 「ソフトウェア」（という概念的なもの）

### ドメインエキスパート

専門家というわけではない、ドメインに自分より詳しい人のこと。

- ユーザ
- 自分よりアプリのことを知っている同僚、友人、など

ドメインエキスパートは、概念的なモデルを持っている。
どんなことをするかを解釈して、蒸留したものを「ドメインモデル」とする。

概念図そのものがドメインモデルというわけではない。  
「概念を共通化したもの」のことをいう。

- 材料を用意する
- 分量を図る
- 手順に沿って
- 調理する…

などのこと。

## ユビキタス言語

ドメインエキスパートを含めたチーム全員が、ユビキタス言語（共通の言語）で会話する。
会話をしていく中で育っていくもの

## 実装

ドメインモデルを作ったら、それをコードで正確に表現するために実装していく。  
ドメインモデルを作り、実装したら、フィードバックして、修正したり、まったく新しいドメインモデルを作ったり、という手順でアジャイル的に進めていく。

1. ユビキタス言語を確立する
2. ドメインモデルを作り上げる　（いきなり実装じゃない
3. ドメインモデルを正確に実装する

1~3を繰り返す。

- ドメインモデルを作り上げるまでに役立つ：戦略的設計
- ドメインモデルを実装するのに役立つ：戦術的設計

### 注

技術的な部分だけを取り入れても、ドメインモデルがなければドメイン駆動設計ではない。

- DDDと[Clean Architecture](http://blog.tai2.net/the_clean_architecture.html)は、イコールではない
- DDDと[MVP](https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93presenter)や[MVC](https://ja.wikipedia.org/wiki/Model_View_Controller)は、仲間ではない
- [レイヤ化アーキテクチャ](http://qiita.com/yuku_t/items/961194a5443b618a4cac)を適用すればDDD、というわけではない

DDDとは、特定のアーキテクチャやパターンに縛られるものではない。

# Androidアプリ開発 with DDD

## 境界付けられたコンテキスト

### コンテキスト

- 文脈
- ユビキタス言語が特定の意味を表すもの

コンテキストが異なると、同じ言葉でも意味が異なる。

### どうやって見つける？

言語の境界 ＝ コンテキストの境界

- 「チーム」の境界
- 「機能」の境界
- 「コードベース」の境界（例：Githubのリポジトリが異なる

### 名前

境界付けられたコンテキストそれぞれに名前をつける ＝ ユビキタス言語になる


## コンテキストマップ

↑ができたら、コンテキストマップを書く。

**理想の姿ではなく、現状の状態をそのまま書くことが大事**

- 最初から完璧な姿でなくて良い、随時修正していけばよい。
- 特定のツールが必要というわけではない。
- 作ったマップはいつでも見れるところに置いておくのがよい。


### コンテキストの統合

統合のパターンはいくつかある。

 - パートナーシップ
 - 共有カーネル, etc...

パターンに名前がついていることは重要。

- パートナーシップ：成功、失敗の運命を共にする
- 順応者：3rd party's SDKを使う
- 公開ホストサービス：RESTとかAPI公開　XML,JSON...
 - サーバからきたモデルをアプリのモデルに適用するために、コンテキストの外側でモデルを変換する


## アーキテクチャ

ドメイン駆動設計では、レイヤ化アーキテクチャを使わなければならない、ということではない。

なぜレイヤ化アーキテクチャを適用したか？→「ドメイン層を隔離したい」

「概念・知識・ビジネスロジックなど」をドメインモデルとして隔離したい  
 → これらが「UI」に埋め込まれることが多い

モック、プロトタイピングなどは、利口なUIになりがち。  
（素早く動くものを見せたい、など短い期間で作ることを求められる場合）

本当は、機能について議論するところから、開発者が一緒に参加して、概念的なものをドメインモデルとして作るところから始めたい。（理想的）

### やること

1. 「ドメインモデルを作る」
2. 「UIからドメインモデルを隔離する」

利口なUIになりがちであることを、まず認識する。  
UIにドメインモデルが存在していないかどうか考える。

この段階では、「戦略的設計」（ドメインモデルを作るための手法）を用いる。

（戦術的設計は、ドメインモデルを正確にコードで表現、実装するための手段）


# 実際のコード例

## 例１

問題なところ

- -1とかの特別な値・意味をUIが知っていること
- マイナスの体重とは一体…

->「体重」を反映したドメインモデルを作る。
 - マイナスの体重、と表現するよりは、0より大きい体重、と表現する方が適切。
 - ドメインにおける「体重」というものは何か、を考える。

## 例2

「性別」について考えること。性別を表現するドメインモデルを作る。

サーバのレスポンスは文字列。ドメインモデルはenumにしたい。->変換


# まとめ

大事なのは「ドメインモデル」。
ドメインを反映したドメインモデルを作る、これがドメイン駆動設計の本質。


# 質疑応答

## 日本語と英語が綺麗に対にならない時、どうするか？

同じ共通概念を持って表現することが大事。

- 日本語でこれになる
- 英語でこれになる

をチームの共通認識としてもつ。

- チームの人と相談する。
- この責務はこういう名前にしよう、と「共通認識」を持つことが大事。


## Validation checkをUIに入れるのは変な感じがする、ドメインモデルに入れるのか、どうすればよいか

（本の中でも触れられているそう）

UIで行われるvalidationと、ドメインモデルで行われるvalidationは粒度が違う。

- 体重が0より大きいかどうかは、ドメインの存在に関わるので、「ドメイン側」に入れる
- 特定のIDの条件を満たしているかどうかは、「ドメイン側」に入れる
- 空文字かどうかは「UI側」でやる
